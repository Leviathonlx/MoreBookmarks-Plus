
# War for Mandala to gain Contributions towards their Mandala Capital Great Project
mandala_plunder_cb = {
	icon = retaliation_cb
	group = mandala
	combine_into_one = yes
	ai_only_against_neighbors = yes
	allow_hostages = yes
	should_show_war_goal_subview = no

	# scope:attacker
	allowed_for_character = {
		has_tgp_dlc_trigger = yes
		government_has_flag = government_is_mandala
		house ?= { has_house_head_parameter = can_use_plunder_for_contribution_cb }
		is_house_head = yes
	}

	allowed_against_character_display_regardless = {
		custom_tooltip = {
			text = not_planning_mandala_capital_tt
			scope:attacker = { has_unfunded_contribution_in_planned_mandala_capital_trigger = yes }
		}
	}

	# scope:defender
	allowed_against_character = {
		government_has_flag = government_is_mandala
	}

	valid_to_start = {

	}

	cost = {
		piety = {
			add = {
				value = 100
				desc = CB_BASE_COST
			}
			multiply = common_cb_piety_cost_multiplier
			if = {
				limit = { 
					scope:attacker = { is_story_godking_trigger = yes }
				}
				multiply = 0.25
			}
		}
	}

	should_invalidate = {
		NOR = {
			scope:attacker = {
				OR = {
					government_has_flag = government_is_mandala
					house = { has_house_power_parameter = aspect_of_destruction }
					is_house_head = yes
					#Still need something to fund
					has_unfunded_contribution_in_planned_mandala_capital_trigger = yes
				}
			}
			scope:defender = {
				government_has_flag = government_is_mandala
			}
		}
	}

	on_invalidated_desc = {
		desc = mandala_plunder_cb_ended_invalid.desc
	}

	on_declaration = {
		on_declared_war = yes
	}

	on_victory_desc = {
		desc = mandala_plunder_cb_victory_desc
	}

	on_victory = {
		# Legitimacy
		add_legitimacy_attacker_victory_effect = yes

		scope:attacker = { 
			show_pow_release_message_effect = yes 

			#EP2 Accolade glory gain from winning against higher ranked enemy
			accolade_attacker_war_end_glory_gain_low_effect = yes

			switch = {
				trigger = scope:defender.primary_title.tier
				tier_county = { add_prestige = minor_prestige_gain }
				tier_duchy = { add_prestige = medium_prestige_gain }
				tier_kingdom = { add_prestige = major_prestige_gain }
				tier_empire = { add_prestige = massive_prestige_gain }
				tier_hegemony = { add_prestige = monumental_prestige_gain }
			}
			switch = {
				trigger = scope:defender.primary_title.tier
				tier_county = { add_piety = minor_piety_gain }
				tier_duchy = { add_piety = medium_piety_gain }
				tier_kingdom = { add_piety = major_piety_gain }
				tier_empire = { add_piety = massive_piety_gain }
				tier_hegemony = { add_piety = monumental_piety_gain }
			}

			random_great_project = {
				limit = {
					great_project_owner = scope:attacker
					great_project_construction_phase_is = planned
					OR = {
						great_project_type = mandala_capital_01
						great_project_type = mandala_capital_02
						great_project_type = mandala_capital_03
						great_project_type = mandala_capital_04
						great_project_type = mandala_capital_05
					}
				}
				add_to_variable_list = {
					name = plundered_contributors
					target = scope:defender
				}
				save_scope_as = target_great_project
				#Check for Mandatory first
				random_contribution = {
					limit = {
						is_owner_only_contribution_trigger = no
						contribution_is_funded = no
						contribution_is_required = yes
					}
					alternative_limit = {
						is_owner_only_contribution_trigger = no
						contribution_is_funded = no
					}
					save_scope_as = contribution_to_fund_by_plunder
				}
			}
		}

		scope:defender = {
			if = {
				limit = {
					exists = scope:contribution_to_fund_by_plunder
				}
				fund_great_project_contribution = {
					contribution = scope:contribution_to_fund_by_plunder
					cost = yes
					check_can_contribute = no
				}
			}
		}
			
		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_both_values = {
			WINNER = scope:attacker
			PRESTIGE_FAME_BASE = major_prestige_value
			PIETY_FAME_BASE = major_piety_value
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}

		# Truce
		add_truce_attacker_victory_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}

	on_white_peace_desc = {
		desc = mandala_plunder_cb_white_peace_desc
	}

	on_white_peace = {
		scope:attacker = { 
			show_pow_release_message_effect = yes
			stress_impact = {
				ambitious = medium_stress_impact_gain
				arrogant = medium_stress_impact_gain
			}
			add_prestige = medium_prestige_loss
			add_piety = medium_piety_loss
		}

		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_both_values = {
			WINNER = scope:attacker # not important as the scales are identical
			PRESTIGE_FAME_BASE = major_prestige_value
			PIETY_FAME_BASE = major_piety_value
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}

		scope:defender = {
			stress_impact = {
				arrogant = medium_stress_impact_gain
			}
		}

		# Truce
		add_truce_attacker_victory_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}

	on_defeat_desc = {
		desc = mandala_plunder_cb_defeat_desc
	}

	on_defeat = {
		# Legitimacy
		add_legitimacy_attacker_defeat_effect = yes

		scope:attacker = { 
			show_pow_release_message_effect = yes 

			switch = {
				trigger = primary_title.tier
				tier_county = { add_prestige = minor_prestige_loss }
				tier_duchy = { add_prestige = medium_prestige_loss }
				tier_kingdom = { add_prestige = major_prestige_loss }
				tier_empire = { add_prestige = massive_prestige_loss }
				tier_hegemony = { add_prestige = monumental_prestige_loss }
			}
			switch = {
				trigger = primary_title.tier
				tier_county = { add_piety = minor_piety_loss }
				tier_duchy = { add_piety = medium_piety_loss }
				tier_kingdom = { add_piety = major_piety_loss }
				tier_empire = { add_piety = massive_piety_loss }
				tier_hegemony = { add_piety = monumental_piety_loss }
			}

			save_temporary_scope_as = loser
		}

		on_lost_aggression_war_discontent_loss = yes
		
		scope:defender = {
			#EP2 Accolade glory gain from winning against higher ranked enemy
			accolade_defender_war_end_glory_gain_low_effect = yes 

			switch = {
				trigger = primary_title.tier
				tier_county = { add_prestige = minor_prestige_gain }
				tier_duchy = { add_prestige = medium_prestige_gain }
				tier_kingdom = { add_prestige = major_prestige_gain }
				tier_empire = { add_prestige = massive_prestige_gain }
				tier_hegemony = { add_prestige = monumental_prestige_gain }
			}
			switch = {
				trigger = primary_title.tier
				tier_county = { add_piety = minor_piety_gain }
				tier_duchy = { add_piety = medium_piety_gain }
				tier_kingdom = { add_piety = major_piety_gain }
				tier_empire = { add_piety = massive_piety_gain }
				tier_hegemony = { add_piety = monumental_piety_gain }
			}
		}

		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_both_values = {
			WINNER = scope:defender
			PRESTIGE_FAME_BASE = major_prestige_value
			PIETY_FAME_BASE = major_piety_value
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}

		# Truce
		add_truce_attacker_defeat_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}

	on_primary_attacker_death = inherit
	on_primary_defender_death = inherit

	attacker_allies_inherit = yes
	defender_allies_inherit = yes

	war_name = "MANDALA_PLUNDER_WAR_NAME"
	war_name_base = "MANDALA_PLUNDER_WAR_NAME_BASE"
	cb_name = "MANDALA_PLUNDER_CB_NAME"
	interface_priority = 80

	ticking_war_score_targets_entire_realm = yes
	attacker_ticking_warscore = 0.01
	attacker_wargoal_percentage = 0.01
	attacker_score_from_occupation_scale = 50
	defender_score_from_occupation_scale = 50
	attacker_score_from_battles_scale = 250
	defender_score_from_battles_scale = 250

	max_attacker_score_from_battles = 200
	max_defender_score_from_battles = 200
	
	max_defender_score_from_occupation = 50
	max_attacker_score_from_occupation = 50

	max_ai_diplo_distance_to_title = 500
	
	ai_score = {
		value = mandala_plunder_ai_score_value
	}

}

# War for Mandala to turn their opponents Mandala Capital into the Ruined state
mandala_raze_capital_structure_cb = {
	icon = raze_capital_structure
	group = mandala
	combine_into_one = yes
	ai_only_against_neighbors = yes
	allow_hostages = yes
	should_show_war_goal_subview = no

	# scope:attacker
	allowed_for_character = {
		has_tgp_dlc_trigger = yes
		government_has_flag = government_is_mandala
		has_mandala_capital_trigger = yes
	}

	# scope:defender
	allowed_against_character = {
		government_has_flag = government_is_mandala
		is_landed = yes
		has_unruined_mandala_capital_trigger = yes
	}

	allowed_against_character_display_regardless = {
		scope:attacker = {
			has_unruined_mandala_capital_trigger = yes
		}
	}

	valid_to_start = {

	}

	cost = {
		piety = {
			add = {
				value = 100
				desc = CB_BASE_COST
			}
			multiply = common_cb_piety_cost_multiplier
			if = {
				limit = { 
					scope:attacker = { is_story_godking_trigger = yes }
				}
				multiply = 0.25
			}
		}
	}

	should_invalidate = {
		NOR = {
			scope:attacker = {
				government_has_flag = government_is_mandala
				has_unruined_mandala_capital_trigger = yes
			}
			scope:defender = {
				government_has_flag = government_is_mandala
				has_unruined_mandala_capital_trigger = yes
			}
		}
	}

	on_invalidated_desc = {
		desc = mandala_raze_capital_structure_cb_ended_invalid.desc
	}

	on_declaration = {
		on_declared_war = yes
	}

	on_victory_desc = {
		desc = mandala_raze_capital_structure_cb_victory_desc
	}

	on_victory = {
		# Legitimacy
		add_legitimacy_attacker_victory_effect = yes

		scope:attacker = { 
			show_pow_release_message_effect = yes

			#EP2 Accolade glory gain from winning against higher ranked enemy
			accolade_attacker_war_end_glory_gain_low_effect = yes

			switch = {
				trigger = scope:defender.primary_title.tier
				tier_county = { add_prestige = minor_prestige_gain }
				tier_duchy = { add_prestige = medium_prestige_gain }
				tier_kingdom = { add_prestige = major_prestige_gain }
				tier_empire = { add_prestige = massive_prestige_gain }
				tier_hegemony = { add_prestige = monumental_prestige_gain }
			}
			switch = {
				trigger = scope:defender.primary_title.tier
				tier_county = { add_piety = medium_piety_gain }
				tier_duchy = { add_piety = major_piety_gain }
				tier_kingdom = { add_piety = massive_piety_gain }
				tier_empire = { add_piety = massive_piety_gain }
				tier_hegemony = { add_piety = monumental_piety_gain }
			}
		}

		scope:defender = {
			switch = {
				trigger = primary_title.tier
				tier_county = { add_prestige = minor_prestige_loss }
				tier_duchy = { add_prestige = medium_prestige_loss }
				tier_kingdom = { add_prestige = major_prestige_loss }
				tier_empire = { add_prestige = massive_prestige_loss }
				tier_hegemony = { add_prestige = monumental_prestige_loss }
			}
			switch = {
				trigger = primary_title.tier
				tier_county = { add_piety = medium_piety_loss }
				tier_duchy = { add_piety = major_piety_loss }
				tier_kingdom = { add_piety = massive_piety_loss }
				tier_empire = { add_piety = massive_piety_loss }
				tier_hegemony = { add_piety = monumental_piety_loss }
			}

			capital_province = {
				if = {
					limit = { has_building_with_flag = mandala_capital_building }
					ruin_great_building = yes
					scope:defender = {
						if = {
							limit = { has_character_flag = devaraja_flag }
							remove_character_flag = devaraja_flag
						}
						if = {
							limit = { has_character_modifier = mandala_rise_from_the_ashes_modifier }
							remove_character_modifier = mandala_rise_from_the_ashes_modifier
						}
					}
				}
			}
		}			

		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_both_values = {
			WINNER = scope:attacker
			PRESTIGE_FAME_BASE = major_prestige_value
			PIETY_FAME_BASE = major_piety_value
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}
		
		# Truce
		add_truce_attacker_victory_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}

	on_white_peace_desc = {
		desc = mandala_raze_capital_structure_cb_white_peace_desc
	}

	on_white_peace = {
		scope:attacker = { 
			show_pow_release_message_effect = yes
			stress_impact = {
				ambitious = medium_stress_impact_gain
				arrogant = medium_stress_impact_gain
			}
			add_prestige = medium_prestige_loss
			add_piety = medium_piety_loss
		}

		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_both_values = {
			WINNER = scope:attacker # not important as the scales are identical
			PRESTIGE_FAME_BASE = major_prestige_value
			PIETY_FAME_BASE = major_piety_value
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}

		scope:defender = {
			stress_impact = {
				arrogant = medium_stress_impact_gain
			}
		}

		# Truce
		add_truce_attacker_victory_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}

	on_defeat_desc = {
		desc = mandala_raze_capital_structure_cb_defeat_desc
	}

	on_defeat = {
		# Legitimacy
		add_legitimacy_attacker_defeat_effect = yes

		scope:attacker = { 
			show_pow_release_message_effect = yes 

			switch = {
				trigger = primary_title.tier
				tier_county = { add_prestige = minor_prestige_loss }
				tier_duchy = { add_prestige = medium_prestige_loss }
				tier_kingdom = { add_prestige = major_prestige_loss }
				tier_empire = { add_prestige = massive_prestige_loss }
				tier_hegemony = { add_prestige = monumental_prestige_loss }
			}
			switch = {
				trigger = primary_title.tier
				tier_county = { add_piety = minor_piety_loss }
				tier_duchy = { add_piety = medium_piety_loss }
				tier_kingdom = { add_piety = major_piety_loss }
				tier_empire = { add_piety = massive_piety_loss }
				tier_hegemony = { add_piety = monumental_piety_loss }
			}

			capital_province = {
				if = {
					limit = { has_building_with_flag = mandala_capital_building }
					ruin_great_building = yes
					scope:attacker = {
						if = {
							limit = {
								has_character_flag = devaraja_flag
							}
							remove_character_flag = devaraja_flag
						}
					}
				}
			}

			save_temporary_scope_as = loser
		}

		on_lost_aggression_war_discontent_loss = yes
			
		scope:defender = {
			mandala_peacemaker_perk_serenity_effect = yes
			#EP2 Accolade glory gain from winning against higher ranked enemy
			accolade_defender_war_end_glory_gain_low_effect = yes

			switch = {
				trigger = primary_title.tier
				tier_county = { add_prestige = minor_prestige_gain }
				tier_duchy = { add_prestige = medium_prestige_gain }
				tier_kingdom = { add_prestige = major_prestige_gain }
				tier_empire = { add_prestige = massive_prestige_gain }
				tier_hegemony = { add_prestige = monumental_prestige_gain }
			}
			switch = {
				trigger = primary_title.tier
				tier_county = { add_piety = minor_piety_gain }
				tier_duchy = { add_piety = medium_piety_gain }
				tier_kingdom = { add_piety = major_piety_gain }
				tier_empire = { add_piety = massive_piety_gain }
				tier_hegemony = { add_piety = monumental_piety_gain }
			}
		}

		# Allies on both sides get full prestige value for helping in the war, based on their war participation.
		modify_allies_of_participants_fame_both_values = {
			WINNER = scope:defender
			PRESTIGE_FAME_BASE = major_prestige_value
			PIETY_FAME_BASE = major_piety_value
			WINNER_ALLY_FAME_SCALE = 1
			LOSER_ALLY_FAME_SCALE = 1
		}

		# Truce
		add_truce_attacker_defeat_effect = yes

		# EP3: note gold gained from military assistance/join war contracts and their war contribution threshold
		laamp_as_mercenary_payout_tooltip_effect = yes
	}

	on_primary_attacker_death = inherit
	on_primary_defender_death = inherit

	attacker_allies_inherit = yes
	defender_allies_inherit = yes

	war_name = "MANDALA_RAZE_CAPITAL_STRUCTURE_WAR_NAME"
	war_name_base = "MANDALA_RAZE_CAPITAL_STRUCTURE_WAR_NAME_BASE"
	cb_name = "MANDALA_RAZE_CAPITAL_STRUCTURE_CB_NAME"
	interface_priority = 80

	ticking_war_score_targets_entire_realm = yes
	attacker_ticking_warscore = 0.01
	attacker_wargoal_percentage = 0.01
	attacker_score_from_occupation_scale = 50
	defender_score_from_occupation_scale = 50
	attacker_score_from_battles_scale = 250
	defender_score_from_battles_scale = 250

	max_attacker_score_from_battles = 200
	max_defender_score_from_battles = 200
	
	max_defender_score_from_occupation = 50
	max_attacker_score_from_occupation = 50

	max_ai_diplo_distance_to_title = 500
	
	ai_score = {
		value = mandala_raze_capital_structure_ai_score_value
	}

}
