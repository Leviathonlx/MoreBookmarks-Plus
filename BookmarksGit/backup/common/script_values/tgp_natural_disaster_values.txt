
# Scale cost by number of affected counties
# Realms pay a premium based on how many counties are involved in the disaster
natural_disaster_contributions_cost_value = {
	add = {
		add = scope:great_project.great_project_owner.minor_gold_value
		min = 100
		multiply = 0.5
		multiply = {
			add = 1
			add = { # first value added as a mult for each county beyond the first
				add = 0.5
				multiply = {
					add = natural_disaster_realm_counties_in_situation_value
					subtract = 1
				}
			}
		}
		desc = great_project_contribution_cost_num_affected_realm_counties
	}
}

natural_disaster_contributions_cost_treasury_value = {
	add = {
		add = scope:great_project.great_project_owner.minor_gold_value
		min = 100
		multiply = 0.5
		multiply = {
			add = 1
			add = { # first value added as a mult for each county beyond the first
				add = 0.5
				multiply = {
					add = natural_disaster_realm_counties_in_situation_value
					subtract = 1
				}
			}
		}
		multiply = 2
		if = {
			limit = { highest_held_title_tier >= tier_empire }
			multiply = 2
		}
		desc = great_project_contribution_cost_num_affected_realm_counties
	}
}

natural_disaster_contributions_cost_base_discount = {
	if = {
		limit = {
			has_variable = natural_disaster_contribution_discount
			var:natural_disaster_contribution_discount > 0
			OR = {
				has_active_diarchy = yes
				location = scope:great_project.great_project_location
			}
		}
		multiply = {
			value = 1
			subtract = var:natural_disaster_contribution_discount
			desc = great_project_contribution_discount
		}
	}
}

natural_disaster_realm_counties_in_situation_value = {
	value = 0
	scope:great_project.var:situation ?= {
		every_situation_sub_region = {
			every_situation_sub_region_county = {
				limit = { holder.top_liege ?= scope:great_project.great_project_owner.top_liege }
				add = 1
			}
		}
	}
	min = 1
}

# Factor based on the total development across affected counties
natural_disaster_realm_counties_total_development_contributions_cost_factor = {
	value = 0
	scope:great_project.var:situation ?= {
		every_situation_sub_region = {
			every_situation_sub_region_county = {
				limit = { holder.top_liege ?= scope:great_project.great_project_owner.top_liege }
				add = {
					add = development_level
					multiply = 0.5
				}
			}
		}
	}
}

natural_disaster_initial_grace_period_years = 10
natural_disaster_passing_of_time_monthly_value = 15
natural_disaster_great_project_investment_catalyst_value = 50
natural_disaster_great_project_completion_catalyst_value = 250
natural_disaster_individual_contribution_cooldown_value = 15

natural_disaster_legitimacy_loss_value = {
	value = -50
	if = {
		limit = { title:h_china.holder ?= this }
		multiply = 2 # Disasters hit the Legitimacy of the Chinese Emperor harder
		if = {
			limit = {
				situation:dynastic_cycle ?= {
					OR = {
						situation_current_phase = situation_dynastic_cycle_phase_instability
						situation_current_phase = situation_dynastic_cycle_phase_instability_conquest
					}
				}
			}
			multiply = 2 # Especially during unstable phases of the Dynastic Cycle
		}
	}
}

natural_disaster_great_project_mandatory_investment_legitimacy_gain_value = {
	value = 25
	if = {
		limit = { 
			title:h_china.holder ?= this 
			situation:dynastic_cycle ?= {
				OR = {
					situation_current_phase = situation_dynastic_cycle_phase_instability
					situation_current_phase = situation_dynastic_cycle_phase_instability_conquest
				}
			}
		}
		multiply = 2 # The Emperor resolving disasters during Instability is proof of the Mandate of Heaven
	}
}

natural_disaster_great_project_optional_investment_legitimacy_gain_value = {
	value = 50
	if = {
		limit = { 
			title:h_china.holder ?= this 
			situation:dynastic_cycle ?= {
				OR = {
					situation_current_phase = situation_dynastic_cycle_phase_instability
					situation_current_phase = situation_dynastic_cycle_phase_instability_conquest
				}
			}
		}
		multiply = 2 # The Emperor resolving disasters during Instability is proof of the Mandate of Heaven
	}
}

natural_disaster_earthquake_epicenter_development_loss_value = {
	value = development_level
	divide = {
		value = 5
		if = {
			limit = {
				exists = scope:situation.var:severity
			}
			subtract = scope:situation.var:severity
		}
		if = {
			limit = {
				scope:situation.situation_participant_group:affected_ruler = {
					any_situation_group_participant = {
						has_character_modifier = tgp_burned_weather_modifier
					}
				}
			}
			multiply = 0.8
		}
	}
	floor = yes
	multiply = -1
	min = -10
	max = -1
}

natural_disaster_earthquake_development_loss_value = {
	value = development_level
	divide = {
		value = 6
		if = {
			limit = {
				exists = scope:situation.var:severity
			}
			subtract = scope:situation.var:severity
		}
		if = {
			limit = {
				scope:situation.situation_participant_group:affected_ruler = {
					any_situation_group_participant = {
						has_character_modifier = tgp_burned_weather_modifier
					}
				}
			}
			multiply = 0.8
		}
	}
	floor = yes
	multiply = -1
	min = -5
	max = -1
}

natural_disaster_flood_development_loss_value = {
	value = development_level
	divide = {
		value = 7
		if = {
			limit = {
				exists = scope:situation.var:severity
			}
			subtract = scope:situation.var:severity
		}
		if = {
			limit = {
				scope:situation.situation_participant_group:affected_ruler = {
					any_situation_group_participant = {
						has_character_modifier = tgp_burned_weather_modifier
					}
				}
			}
			multiply = 0.8
		}
	}
	floor = yes
	multiply = -1
	min = -5
	max = -1
}

natural_disaster_flood_development_loss_fraction_value = {
	value = 7
	if = {
		limit = {
			exists = scope:situation.var:severity
		}
		subtract = scope:situation.var:severity
	}
	if = {
		limit = {
			scope:situation.situation_participant_group:affected_ruler = {
					any_situation_group_participant = {
						has_character_modifier = tgp_burned_weather_modifier
					}
				}
		}
		multiply = 0.8
	}
}

natural_disaster_flood_fertility_loss_value = {
	value = county_fertility
	divide = {
		value = 5
		if = {
			limit = {
				exists = scope:situation.var:severity
			}
			subtract = scope:situation.var:severity
		}
	}
	multiply = -1
	max = -1
}

natural_disaster_earthquake_control_loss_value = {
	value = county_control
	divide = {
		value = 5
		if = {
			limit = {
				exists = scope:situation.var:severity
			}
			subtract = scope:situation.var:severity
		}
	}
	multiply = -1
	max = -1
}

natural_disaster_flood_control_loss_value = {
	value = county_control
	divide = {
		value = 7
		if = {
			limit = {
				exists = scope:situation.var:severity
			}
			subtract = scope:situation.var:severity
		}
	}
	multiply = -1
	max = -1
}

natural_disaster_army_supply_loss_value = {
	value = 0
	scope:situation = {
		switch = {
			trigger = situation_type
			natural_disaster_earthquake = { add = 0.25 }
			natural_disaster_flood = { add = 0.50 }
		}
		multiply = { # Average 1.0; 0.83 at Severity 1, 1.17 at Severity 2 1.5 at Severity 3 
			add = 0.5
			multiply = {
				add = var:severity
				multiply = 0.33
			}
			min = 0.75
		}
	}
}

natural_disaster_army_deplete_value = {
	value = 0
	scope:situation = {
		switch = {
			trigger = situation_type
			natural_disaster_earthquake = { add = 0.15 }
			natural_disaster_flood = { add = 0.33 }
		}
		multiply = { # Average 1.0; 0.83 at Severity 1, 1.17 at Severity 2 1.5 at Severity 3 
			add = 0.5
			multiply = {
				add = var:severity
				multiply = 0.33
			}
			min = 0.75
		}
	}
}

natural_disaster_earthquake_frequent_region_chance_per_year_value = 1 # Extra yearly chance for more frequently quaking regions
natural_disaster_earthquake_stacked_region_chance_per_year_value = -0.5 # Lower yearly chance for regions with an ongoing quake
natural_disaster_flood_frequent_region_chance_per_year_value = 1 # Extra yearly chance for more frequently flooding rivers

# Chance per severity level, average severity = 1.5
# With 3 instances of inflicting damage, this resolves to an average of 20% base risk of dying.

natural_disaster_base_death_chance_value = {
	value = 5
	multiply = scope:situation.var:severity
	if = {
		limit = { has_character_modifier = isolating_modifier }
		multiply = 0.25 # 75% reduction to base chance
	}
}
