##################################################
# PRIMEMINISTERSHIPS
## Power sharing arrangements where the diarch is expected to hold authority semi-permanently in order to assist their liege, but still derives that authority from their liege rather than themselves.

# Vizierates
## A type of diarchy accessible to clans, where the chief minister exercises huge amounts of discretion on behalf of their ruler. This frees the ruler up to better perform at many tasks, but poses greater long-term risks.
## Generally intended to be lower tempo than regencies.
vizierate = {
	# Handled via content - this is only for power sharing arrangements we want to start automatically.
	start = { always = yes }

	end = {
		liege = {
			NOT = { government_has_flag = may_appoint_viziers }
		}
	}

	# Mandates
	## Just the standard suite
	mandate = fill_coffers
	mandate = swell_armies
	mandate = promote_authority
	## Aptitudes.
	aptitude_score = {
		add = mandate_type_qualification:fill_coffers
		add = mandate_type_qualification:swell_armies
		add = mandate_type_qualification:promote_authority
	}
	
	# Scales of Power
	## 000
	power_level = {
		swing = 0
		parameter = unlock_syphon_treasury_interaction
		parameter = unlock_shift_privileges_interaction
		parameter = unlock_mulct_vizier_interaction
		parameter = lieges_swing_more_against_diarchs
		# We put a toggle on here so we can early out of diarchy checks for tax collectors a little faster + explicitly list the diarch bonus.
		parameter = diarch_aptitude_helps_tax_collectors_toggle
	}
	## 020
	power_level = {
		swing = 20
		parameter = primeminister_dismissal_will_upset_administration
		parameter = primeminister_requires_county
		parameter = diarch_aptitude_helps_tax_collectors_t1
	}
	## 040
	power_level = {
		swing = 40
		parameter = diarch_aptitude_helps_tax_collectors_t2
	}
	## 60
	power_level = {
		swing = 60
		parameter = primeminister_requires_duchy
		parameter = diarch_aptitude_helps_tax_collectors_t3
		parameter = liege_pays_currency_surcharge_for_mundane_interactions_mild
	}
	power_level = {
		swing = 60
		hidden_parameter = vizier_cannot_be_snaked
	}
	## 70
	power_level = {
		swing = 70
		parameter = liege_pays_currency_surcharge_for_mundane_interactions_medium
	}
	## 080
	power_level = {
		swing = 80
		parameter = diarch_aptitude_helps_tax_collectors_t4
		parameter = liege_pays_currency_surcharge_for_mundane_interactions_major
	}
	## 90
	power_level = {
		swing = 90
		parameter = liege_pays_currency_surcharge_for_mundane_interactions_massive
		parameter = regents_can_try_to_overthrow_present_lieges
	}

	# Trend towards an even balance of power.
	swing_balance = {
		value = 40

		# FP3: some phases empower viziers.
		if = {
			limit = {
				any_character_struggle = {
					involvement = involved
					has_struggle_phase_parameter = empowered_vizierate
				}
			}
			add = fp3_empower_viziers_swing_value
		}
	}

	succession = yes
	# Candidate scoring for succession.
	candidate_score = { add = diarchy_vizier_succession_score_value }

	# Container for hidden parameters.
	power_level = {
		swing = 0
		hidden_parameter = diarchy_is_vizierate
		hidden_parameter = vizier_sits_in_the_council_instead_of_spouse
		# This one isn't hooked up to anything yet - just here to establish a parameter standard for mods & potential... _future_ diarchies.
		hidden_parameter = diarchy_is_primeministership
		hidden_parameter = mandate_tempo_slow
	}

	loyalty_score = { add = diarch_loyalty_score_type_vizierate_value }

	end_interaction = liege_dismiss_vizier_interaction

	liege_modifier = {
		name = from_diarch_domain_limit_bonus
		tax_slot_add = 1
		scale = { add = vizier_bonus_tax_jurisdictions_value }
	}

	diarch_modifier = {
		name = family_member_is_civil_servant
		stress_gain_mult = 0.3
		monthly_dynasty_prestige = -0.25
	}
	diarch_modifier = {
		name = civil_servant_salary_and_corruption
		monthly_income = 1
		scale = {
			add = liege.monthly_character_balance
			multiply = {
				add = stewardship
				# Get nearest complete 5.
				divide = 5
				round = yes
				min = 1
				# And fractalise.
				divide = 20
				# So we should be getting something like 5% of our liege's income per 5 stewardship, with rounding errors.
				## Plus, y'know, Paradox maths.
			}
		}
	}
}

grand_secretariat = {
	# Handled via content - this is only for power sharing arrangements we want to start automatically.
	start = { always = yes }

	end = {
		liege = {
			NOR = {
				government_has_flag = government_is_celestial
				highest_held_title_tier >= tier_hegemony
			}
		}
	}

	# Mandates
	## Dynastic Cycle specific suite
	mandate = placate_movements
	mandate = promote_might
	mandate = promote_merit
	## Aptitudes.
	aptitude_score = {
		add = mandate_type_qualification:placate_movements
		if = {
			limit = {
				this = title:e_minister_chancellor.holder
			}
			add = mandate_type_qualification:promote_merit
		}
		else = {
			add = mandate_type_qualification:promote_might
		}
		if = {
			limit = {
				exists = var:movement_power
			}
			add = {
				value = var:movement_power
				multiply = 0.1
				desc = grand_secretariat_aptitude.movement_power
			}
		}
	}
	
	# Scales of Power
	## 000
	power_level = {
		swing = 0
		parameter = unlock_shift_privileges_interaction
		parameter = diarch_movement_power
		parameter = diarch_disciple_limit
	}
	## 020
	power_level = {
		swing = 20
		parameter = unlock_diarch_imprison_interaction
	}
	## 040
	power_level = {
		swing = 40
		parameter = diarch_gets_a_free_change_on_vassal_contract
		parameter = liege_pays_currency_surcharge_for_mundane_interactions_mild
	}
	## 70
	power_level = {
		swing = 60
		parameter = unlock_diarch_set_own_mandate_interaction
		parameter = liege_pays_currency_surcharge_for_mundane_interactions_medium
	}
	## 080
	power_level = {
		swing = 80
		parameter = liege_pays_currency_surcharge_for_mundane_interactions_major
		parameter = unlock_scapegoat_counterpart_interaction
	}
	## 90
	power_level = {
		swing = 90
		parameter = liege_pays_currency_surcharge_for_mundane_interactions_massive
		parameter = regents_can_try_to_overthrow_present_lieges
		parameter = regents_can_try_to_overthrow_present_lieges_help
	}

	# Trend towards an even balance of power.
	swing_balance = {
		value = 40
	}

	succession = yes
	# Candidate scoring for succession.
	candidate_score = {
		value = 0
		# If the Grand Chancellor is the director, set score accordingly
		if = {
			limit = {
				top_liege = {
					has_realm_law = grand_chancellor_law
				}
			}
			if = {
				limit = {
					title:h_china.holder.cp:councillor_chancellor ?= this
					current_date_is_start_date_trigger = yes
				}
				add = 1000
			}
			if = {
				limit = {
					title:e_minister_chancellor = {
						place_in_line_of_succession = {
							target = root
							value = 1
						}
					}
				}
				add = {
					value = 120
					desc = diarch_candidate_score.grand_secretariat.successor_1
				}
			}
			if = {
				limit = {
					title:e_minister_chancellor = {
						place_in_line_of_succession = {
							target = root
							value = 2
						}
					}
				}
				add = {
					value = 80
					desc = diarch_candidate_score.grand_secretariat.successor_2
				}
			}
			if = {
				limit = {
					title:e_minister_chancellor = {
						place_in_line_of_succession = {
							target = root
							value = 3
						}
					}
				}
				add = {
					value = 50
					desc = diarch_candidate_score.grand_secretariat.successor_3
				}
			}
			if = {
				limit = {
					title:e_minister_chancellor = {
						place_in_line_of_succession = {
							target = root
							value = 4
						}
					}
				}
				add = {
					value = 30
					desc = diarch_candidate_score.grand_secretariat.successor_4
				}
			}
			# Censor and Marshal acts as fallbacks
			if = {
				limit = {
					has_title = title:e_minister_censor
				}
				add = {
					value = 25
					desc = "[minister_censor|E]"
				}
			}
			if = {
				limit = {
					has_title = title:e_minister_grand_marshal
				}
				add = {
					value = 20
					desc = "[minister_grand_marshal|E]"
				}
			}
			# Have the matching province type
			if = {
				limit = {
					vassal_contract_has_flag = celestial_civil_appointment
				}
				add = {
					value = 10
					desc = diarch_candidate_score.grand_secretariat.military # actually civilian
				}
			}
		}
		# If the Grand Marshal is the director, set score accordingly
		else_if = {
			limit = {
				top_liege = {
					has_realm_law = grand_marshal_law
				}
			}
			if = {
				limit = {
					title:h_china.holder.cp:minister_grand_marshal ?= this
					current_date_is_start_date_trigger = yes
				}
				add = 1000
			}
			if = {
				limit = {
					title:e_minister_grand_marshal = {
						place_in_line_of_succession = {
							target = root
							value = 1
						}
					}
				}
				add = {
					value = 120
					desc = diarch_candidate_score.grand_secretariat.successor_1
				}
			}
			if = {
				limit = {
					title:e_minister_grand_marshal = {
						place_in_line_of_succession = {
							target = root
							value = 2
						}
					}
				}
				add = {
					value = 80
					desc = diarch_candidate_score.grand_secretariat.successor_2
				}
			}
			if = {
				limit = {
					title:e_minister_grand_marshal = {
						place_in_line_of_succession = {
							target = root
							value = 3
						}
					}
				}
				add = {
					value = 50
					desc = diarch_candidate_score.grand_secretariat.successor_3
				}
			}
			if = {
				limit = {
					title:e_minister_grand_marshal = {
						place_in_line_of_succession = {
							target = root
							value = 4
						}
					}
				}
				add = {
					value = 30
					desc = diarch_candidate_score.grand_secretariat.successor_4
				}
			}
			# Chancellor and Censor acts as fallbacks
			if = {
				limit = {
					has_title = title:e_minister_chancellor
				}
				add = {
					value = 25
					desc = "[minister_grand_chancellor|E]"
				}
			}
			if = {
				limit = {
					has_title = title:e_minister_censor
				}
				add = {
					value = 20
					desc = "[minister_censor|E]"
				}
			}
			# Have the matching province type
			if = {
				limit = {
					vassal_contract_has_flag = celestial_military_appointment
				}
				add = {
					value = 10
					desc = diarch_candidate_score.grand_secretariat.civilian # actually military
				}
			}
		}
		# If the Imperial Censor is the director, set score accordingly
		else_if = {
			limit = {
				top_liege = {
					has_realm_law = grand_censor_law
				}
			}
			if = {
				limit = {
					title:h_china.holder.cp:councillor_spymaster ?= this
					current_date_is_start_date_trigger = yes
				}
				add = 1000
			}
			if = {
				limit = {
					title:e_minister_censor = {
						place_in_line_of_succession = {
							target = root
							value = 1
						}
					}
				}
				add = {
					value = 120
					desc = diarch_candidate_score.grand_secretariat.successor_1
				}
			}
			if = {
				limit = {
					title:e_minister_censor = {
						place_in_line_of_succession = {
							target = root
							value = 2
						}
					}
				}
				add = {
					value = 80
					desc = diarch_candidate_score.grand_secretariat.successor_2
				}
			}
			if = {
				limit = {
					title:e_minister_censor = {
						place_in_line_of_succession = {
							target = root
							value = 3
						}
					}
				}
				add = {
					value = 50
					desc = diarch_candidate_score.grand_secretariat.successor_3
				}
			}
			if = {
				limit = {
					title:e_minister_censor = {
						place_in_line_of_succession = {
							target = root
							value = 4
						}
					}
				}
				add = {
					value = 30
					desc = diarch_candidate_score.grand_secretariat.successor_4
				}
			}
			# Chancellor and Marshal acts as fallbacks
			if = {
				limit = {
					has_title = title:e_minister_chancellor
				}
				add = {
					value = 25
					desc = "[minister_grand_chancellor|E]"
				}
			}
			if = {
				limit = {
					has_title = title:e_minister_grand_marshal
				}
				add = {
					value = 20
					desc = "[minister_grand_marshal|E]"
				}
			}
			# Have the matching province type
			if = {
				limit = {
					vassal_contract_has_flag = celestial_military_appointment
				}
				add = {
					value = 10
					desc = diarch_candidate_score.grand_secretariat.military # actually civilian
				}
			}
		}
		# Other sources of score
		if = {
			limit = {
				top_participant_group:dynastic_cycle ?= {
					exists = var:movement_favored
				}
			}
			add = {
				value = 10
				desc = diarch_candidate_score.grand_secretariat.favored
			}
		}
		if = {
			limit = {
				top_participant_group:dynastic_cycle ?= {
					participant_group_type = pro_hegemon_movement
				}
			}
			add = {
				value = 5
				desc = diarch_candidate_score.grand_secretariat.pro_hegemon
			}
		}
		add = {
			value = 5
			multiply = {
				value = merit_level
				subtract = 7 # We make 7 the baseline, since this unlocks empire tier titles
			}
			desc = merit_level_desc
		}
	}

	end_interaction = liege_dismiss_entrenched_regency_interaction

	# Container for hidden parameters.
	power_level = {
		swing = 0
		hidden_parameter = dismissal_requires_no_ministry
		hidden_parameter = diarchy_is_grand_secretariat
		# This one isn't hooked up to anything yet - just here to establish a parameter standard for mods & potential... _future_ diarchies.
		hidden_parameter = diarchy_is_primeministership
		hidden_parameter = mandate_tempo_slow
	}

	loyalty_score = {
		value = 0
		if = {
			limit = {
				liege = {
					has_realm_law = grand_marshal_law
				}
			}
			add = diarch_loyalty_score_type_grand_marshall_value
		}
		else = {
			add = diarch_loyalty_score_type_grand_chancellor_value
		}
	}

	liege_modifier = {
		name = grand_secretariat_bonus
		monthly_influence_mult = 0.05
		scale = {
			add = diarch.years_as_diarch
			divide = co_emperor_scale_years_in_job_value
			round = yes
			# Add 1 so that we get incomplete 5 years rather than making you wait for the first 5.
			add = 1
		}
	}
	diarch_modifier = {
		name = grand_secretariat_bonus
		monthly_influence = 1
		scale = {
			add = diarch.years_as_diarch
			divide = co_emperor_scale_years_in_job_value
			round = yes
			# Add 1 so that we get incomplete 5 years rather than making you wait for the first 5.
			add = 1
		}
	}
	diarch_modifier = {
		name = grand_secretariat_bonus
		diplomacy_per_merit_level = 0
		scale = {
			add = 0.3
			round = yes
			if = {
				limit = {
					liege = {
						has_realm_law = grand_marshal_law
					}
				}
				multiply = 0
			}
		}
	}
	diarch_modifier = {
		name = grand_secretariat_bonus
		martial_per_merit_level = 0
		scale = {
			add = 0.3
			round = yes
			if = {
				limit = {
					liege = {
						has_realm_law = grand_chancellor_law
					}
				}
				multiply = 0
			}
		}
	}
}
