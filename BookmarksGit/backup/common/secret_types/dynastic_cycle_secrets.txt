#NOTE!
#When you add new secrets, make sure they're properly included in these scripted triggers:
# trait_is_shunned_in_faith_trigger
# trait_is_criminal_in_faith_trigger
# secret_is_shunned_in_faith_trigger
# secret_is_criminal_in_faith_trigger

#Also, all secrets should be added through their associated scripted effect/effects, not by the add_secret effect

secret_siphoned_treasury = {
	category = civil

	is_valid = {
		secret_siphoned_treasury_is_valid_trigger = {
			OWNER = scope:secret_owner
			TARGET = scope:secret_target
		}
	}

	is_shunned = {
		NOT = {
			secret_siphoned_treasury_is_criminal_trigger = {
				OWNER = scope:secret_owner
				TARGET = scope:secret_target
			}
		}
	}

	is_criminal = {
		secret_siphoned_treasury_is_criminal_trigger = {
			OWNER = scope:secret_owner
			TARGET = scope:secret_target
		}
	}

	on_discover = {}

	on_expose = {
		save_scope_as = secret
		#TODO_CD_TGP: Add a justice minister somewhere in between here to deal with the embezzlers
		#if you siphoned from yourself let the top liege get angry
		if = {
			limit = {
				scope:secret_target ?= scope:secret_owner
				scope:secret_target.liege != scope:secret_owner
			}
			scope:secret_target.liege = {
				save_scope_as = siphoned_treasury_victim
			}
		}
		#else let the discoverer get angry
		else_if = {
			limit = {
				scope:secret_target ?= scope:secret_owner
			}
			scope:discoverer = {
				save_scope_as = siphoned_treasury_victim
			}
		}
		#in any other case let the holder get angry
		else = {
			scope:secret_target ?= {
				save_scope_as = siphoned_treasury_victim
			}
		}
		# Grab the variable value in case it gets erased.
		save_scope_value_as = {
			name = embezzlement_stake
			value = var:embezzlement_stake
		}
		save_scope_value_as = {
			name = embezzlement_stake_half
			value = {
				value = var:embezzlement_stake
				multiply = 0.5
			}
		}
		
		scope:secret_owner = {
			save_scope_as = embezzler
			trigger_event = secrets.0121
		}
	}
}
